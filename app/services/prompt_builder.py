from app.schemas import Questionnaire

# Расширенная таблица соответствия длительности и количества слов
DURATION_TO_CHARS = {
    5: {"min": 3000, "max": 3500},
    6: {"min": 3600, "max": 4200},
    7: {"min": 4200, "max": 4900},
    8: {"min": 4800, "max": 5600},
    9: {"min": 5400, "max": 6300},
    10: {"min": 6000, "max": 7000},
    11: {"min": 6600, "max": 7700},
    12: {"min": 7200, "max": 8400},
    13: {"min": 7800, "max": 9100},
    14: {"min": 8400, "max": 9800},
    15: {"min": 9000, "max": 10500},
    16: {"min": 9600, "max": 11200},
    17: {"min": 10200, "max": 11900},
    18: {"min": 10800, "max": 12600},
    19: {"min": 11400, "max": 13300},
    20: {"min": 12000, "max": 14000},
    21: {"min": 12600, "max": 14700},
    22: {"min": 13200, "max": 15400},
    23: {"min": 13800, "max": 16100},
    24: {"min": 14400, "max": 16800},
    25: {"min": 15000, "max": 17500},
    26: {"min": 15600, "max": 18200},
    27: {"min": 16200, "max": 18900},
    28: {"min": 16800, "max": 19600},
    29: {"min": 17400, "max": 20300},
    30: {"min": 18000, "max": 21000},
    31: {"min": 18600, "max": 21700},
    32: {"min": 19200, "max": 22400},
    33: {"min": 19800, "max": 23100},
    34: {"min": 20400, "max": 23800},
    35: {"min": 21000, "max": 24500},
    36: {"min": 21600, "max": 25200},
    37: {"min": 22200, "max": 25900},
    38: {"min": 22800, "max": 26600},
    39: {"min": 23400, "max": 27300},
    40: {"min": 24000, "max": 28000},
    41: {"min": 24600, "max": 28700},
    42: {"min": 25200, "max": 29400},
    43: {"min": 25800, "max": 30100},
    44: {"min": 26400, "max": 30800},
    45: {"min": 27000, "max": 31500},
    46: {"min": 27600, "max": 32200},
    47: {"min": 28200, "max": 32900},
    48: {"min": 28800, "max": 33600},
    49: {"min": 29400, "max": 34300},
    50: {"min": 30000, "max": 35000},
    51: {"min": 30600, "max": 35700},
    52: {"min": 31200, "max": 36400},
    53: {"min": 31800, "max": 37100},
    54: {"min": 32400, "max": 37800},
    55: {"min": 33000, "max": 38500},
    56: {"min": 33600, "max": 39200},
    57: {"min": 34200, "max": 39900},
    58: {"min": 34800, "max": 40600},
    59: {"min": 35400, "max": 41300},
    60: {"min": 36000, "max": 42000},
}

def prompt_user_builder(data: Questionnaire) -> dict:
    word_range = DURATION_TO_CHARS.get(
        data.story_duration_minutes,
        {"min": data.story_duration_minutes * 120, "max": data.story_duration_minutes * 138}
    )

    # Форматируем возраст
    age_text = f"{data.age_years} лет"
    if data.age_months > 0:
        age_text += f" {data.age_months} месяцев"

    # Форматируем гендер
    gender = {"M": "boy", "F": "girl"}.get(data.gender, "any gender")

    # Форматируем язык
    language = {"РУС": "Russian", "ENG": "English", "FRA": "French"}.get(data.language)

    awg_chars = (word_range['min'] + word_range['max']) / 2


    system_message = """Ты — сказочник, создающий развивающие сказки для детей, с учётом культурных традиций и педагогических целей.

    **ТВОЯ РОЛЬ И ЭКСПЕРТИЗА:**
    - Специалист по детскому развитию и возрастному контенту
    - Знаток мировых культурных традиций сказок
    - Эксперт по развитию словарного запаса через повествование
    - Педагог по развитию софт-скиллов через действия персонажей
    - Создатель безопасного, увлекательного контента без пугающих элементов

    **ОБЯЗАТЕЛЬНАЯ СТРУКТУРА СКАЗКИ:**
    Экспозиция (10-15%) → Завязка (5-10%) → Развитие (50-70%) → Кульминация (10-15%) → Развязка (5-10%)

    **КЛЮЧЕВЫЕ ПРИНЦИПЫ:**
    - Повествование от третьего лица
    - Исключи тревожные или пугающие сцены (потеря, одиночество, болезнь, увечье, конфликты, разрушения)
    - Никаких религиозных упоминаний
    - Возрастной словарь с естественными пояснениями незнакомых слов
    - Ритмичный, выразительный язык для чтения вслух
    - Тёплый, поддерживающий, слегка волшебный тон
    - Показывай навыки через действия, а не прямые заявления
    - "Безопасная симуляция" — ошибки как возможности для обучения
    - Финал с мягким приглашением к размышлению

    **КОНТРОЛЬ КАЧЕСТВА:**
    - Каждое целевое слово используется минимум 2 раза в разных контекстах
    - Софт-скиллы демонстрируются через решающие действия в кульминации
    - Логичный переход между этапами сюжета
    - Действия героев соответствуют их мотивации и росту
    - Аутентичное представление культурной традиции
    - Содержание категории G (для всех возрастов)

    **ЗАПРЕТЫ:**
    - Строго запрещено использовать служебные обозначения этапов сюжета в финальном тексте
    - Не упоминай целевые софт-скиллы в явном виде
    - Не вставляй заголовки, списки или маркировки частей сюжета
    - Не используй механические определения или словари"""

    user_message = f"""Сочини сказку для вслухового чтения по следующим параметрам:

    **ПАРАМЕТРЫ СКАЗКИ:**
    - Язык: {language}
    - Пол главного героя: {gender}
    - Возраст ребёнка: {age_text}
    - Культурная традиция: {data.ethnography_choice} (учитывай мотивы, архетипы, персонажей, метафоры и моральные уроки традиции)
    - Длительность: {data.story_duration_minutes} минут (от {word_range['min']} до {word_range['max']} символов)
    - Интересы ребёнка: {", ".join(data.subcategories)}
    - Слова для запоминания: {", ".join(data.target_words)} (встрой органично в текст, используй минимум 2 раза каждое, поясняй незнакомые через действия или диалоги)
    - Целевые софт-скиллы: {data.soft_skills} (развивай через сюжетные ситуации, диалоги и действия персонажей)

    **ДЕТАЛИЗАЦИЯ СТРУКТУРЫ:**

    Экспозиция — начало сказки с базовыми сведениями о мире истории: где, когда, кто главный герой, его обстоятельства, черты характера, обстановка. Создай "почву" для читателя, задай тон и атмосферу. Ответь на вопросы: кто? где? когда? Введи ключевых героев, намекни на их качества. Используй яркие описания мира, короткие бытовые сцены. Не перегружай фактами — создай живой мир и оставь интерес.

    Завязка — момент появления события, запускающего изменения. "Первый толчок" к действию, причина изменения спокойного мира. Чёткий переход от спокойствия к действию, первый конфликт или вызов. Сформулируй главные вопросы истории: удастся ли герою справиться? Какая цель перед ним? Покажи, что герой должен действовать иначе.

    Развитие — самая большая часть. Серия событий, показывающих ответ героя на вызов: пробует пути, ошибается, учится, взаимодействует с персонажами, сталкивается с трудностями, продвигается к цели. Углубляй характеры, показывай изменения героев. Создай динамику с нарастающим напряжением. Действия героя должны логично вытекать из характера.

    Кульминация — вершина напряжения. Наибольший вызов, критическая ситуация, сильнейший противник. Здесь решается, сможет ли герой преодолеть препятствие и достичь цели. Раскрой главную интригу. Герой использует всё изученное или делает выбор, показывающий рост. Ключевой софтскилл проверяется в действии.

    Развязка — финал, показывающий изменения после кульминации. Судьбы героев понятны, конфликт исчерпан. Ответь на вопросы: что стало с героем? Чему научился? Что с миром? Сделай ясной, светлой и доброй. Содержи скрытый вопрос — приглашение применить опыт в жизни.

    Создай цельную художественную историю, которая звучит естественно при чтении вслух с теплотой и выражением. Сказка должна быть волшебной и увлекательной, тонко развивая целевые софт-скиллы и словарный запас."""

    return {
        "system": system_message,
        "user": user_message,
        "awg": awg_chars
    }